# =============================================================================
# √âTAPE 01 v2 : QUERY PROCESSING & EXPANSION - CONFIGURATION MODULAIRE
# =============================================================================
# Configuration avec activation/d√©sactivation individuelle de chaque sous-√©tape.
#
# NOUVEAUT√â v2.1 :
# - Section MASTER CONFIG : activer/d√©sactiver chaque √©tape facilement
# - PRESETS : configurations pr√©d√©finies (minimal, balanced, maximal)
# - Matrice de d√©pendances : validation automatique
# - Mode debug : logging d√©taill√© de chaque √©tape
# =============================================================================

# =============================================================================
# ‚öôÔ∏è MASTER CONFIGURATION - ACTIVATION/D√âSACTIVATION DES SOUS-√âTAPES
# =============================================================================
# Activer/d√©sactiver individuellement chaque sous-√©tape de la Phase 01.
# Changez simplement true/false pour activer/d√©sactiver.
#
# ATTENTION : Certaines √©tapes ont des d√©pendances (voir matrice ci-dessous)
# =============================================================================

step_01_config:
  # ---------------------------------------------------------------------------
  # MODE DE CONFIGURATION
  # ---------------------------------------------------------------------------
  # Options : "preset", "custom"
  # - "preset" : utilise un preset pr√©d√©fini (voir section presets)
  # - "custom" : configuration manuelle via les flags ci-dessous
  mode: "preset"

  # Preset √† utiliser si mode="preset"
  # Options : "minimal", "balanced", "maximal", "legacy_v1"
  preset: "balanced"

  # ---------------------------------------------------------------------------
  # FLAGS D'ACTIVATION (utilis√©s si mode="custom")
  # ---------------------------------------------------------------------------
  # Cochez true/false pour activer/d√©sactiver chaque sous-√©tape

  # [1.1] Query Understanding & Classification
  step_1_1_query_understanding:
    enabled: true                          # ‚≠ê Recommand√©
    type_classification: true              # Classifier le type de query
    intent_detection: true                 # D√©tecter l'intention
    complexity_scoring: true               # Mesurer la complexit√©

  # [1.2] Query Preprocessing
  step_1_2_query_preprocessing:
    enabled: true                          # ‚≠ê Recommand√©
    spell_correction: true                 # Corriger fautes orthographe
    grammar_normalization: true            # Normaliser grammaire
    synonym_expansion: false               # Expander synonymes (optionnel)
    acronym_expansion: false               # Expander acronymes (optionnel)

  # [1.3] Named Entity Recognition
  step_1_3_ner:
    enabled: true                          # ‚≠ê Recommand√©
    entity_extraction: true                # Extraire entit√©s
    entity_boosting: true                  # Boosting au retrieval
    entity_linking: false                  # Linking KB (optionnel, lent)

  # [1.4] Query Decomposition
  step_1_4_decomposition:
    enabled: true                          # ‚≠ê Important pour queries complexes
    # Attention : n√©cessite LLM si method="llm"

  # [1.5] Metadata Extraction
  step_1_5_metadata:
    enabled: true                          # ‚≠ê Recommand√©
    temporal_filters: true                 # Extraction dates
    geographic_filters: true               # Extraction lieux
    domain_filters: true                   # Classification domaine
    format_filters: false                  # D√©tection format doc (optionnel)

  # [1.6] Adaptive Query Expansion
  step_1_6_expansion:
    enabled: true                          # ‚≠ê‚≠ê‚≠ê CRITIQUE
    # Note : utilise les r√©sultats de 1.1 (query understanding)
    technique_rewrite: true                # Query rewriting
    technique_hyde: true                   # HyDE (hypothetical doc)
    technique_multi_query: true            # Multi-query variants
    technique_step_back: true              # Step-back prompting
    technique_simplification: false        # Simplification (optionnel)
    technique_subquery: false              # Sub-query extraction (optionnel)
    domain_specific_prompts: true          # Prompts par domaine

  # [1.7] Multi-Representation Embedding
  step_1_7_embedding:
    enabled: true                          # ‚≠ê‚≠ê‚≠ê CRITIQUE
    dense_embedding: true                  # Dense (BGE-M3) - OBLIGATOIRE
    sparse_embedding: false                # Sparse (SPLADE) - n√©cessite index hybride
    late_interaction: false                # ColBERT - n√©cessite index ColBERT

  # [1.8] Query Quality Validation
  step_1_8_validation:
    enabled: true                          # ‚≠ê Recommand√©
    completeness_check: true               # V√©rifier compl√©tude
    ambiguity_detection: true              # D√©tecter ambigu√Øt√©s
    semantic_coherence: true               # V√©rifier coh√©rence
    variant_filtering: true                # Filtrer mauvaises variantes

  # [1.9] Ranking Feedback Integration (RaFe)
  step_1_9_feedback:
    enabled: false                         # ‚ö†Ô∏è D√©sactiv√© par d√©faut (+100ms)
    # Note : n√©cessite r√©sultats retrieval (Phase 02)
    # Activer uniquement si qualit√© primordiale et budget latence OK

  # [1.10] Query Packaging & Caching
  step_1_10_packaging:
    enabled: true                          # ‚≠ê‚≠ê‚≠ê OBLIGATOIRE
    caching: true                          # Cache r√©sultats
    metrics_tracking: true                 # Tracker m√©triques
    export_prometheus: false               # Export Prometheus (optionnel)

# =============================================================================
# üì¶ PRESETS DE CONFIGURATION
# =============================================================================
# Configurations pr√©d√©finies pour d√©marrage rapide.
# S√©lectionner via : step_01_config.mode="preset" et step_01_config.preset="..."
# =============================================================================

presets:
  # ---------------------------------------------------------------------------
  # PRESET : minimal (Quick Start)
  # ---------------------------------------------------------------------------
  # Configuration minimale pour d√©marrage rapide.
  # Gains : +20-30% qualit√©, +30ms latence
  # Effort : 3-5 jours impl√©mentation
  # Use case : FAQ, Support Client, Latence critique
  # ---------------------------------------------------------------------------
  minimal:
    description: "Configuration minimale - Quick Start"
    latency_target_ms: 80
    quality_gain_estimate: "+20-30%"

    enabled_steps:
      step_1_1_query_understanding:
        enabled: true
        type_classification: true          # Heuristic seulement
        intent_detection: false
        complexity_scoring: true

      step_1_2_query_preprocessing:
        enabled: true
        spell_correction: true             # SymSpell
        grammar_normalization: false
        synonym_expansion: false
        acronym_expansion: false

      step_1_3_ner:
        enabled: false                     # D√©sactiv√© pour latence

      step_1_4_decomposition:
        enabled: false                     # D√©sactiv√© pour latence

      step_1_5_metadata:
        enabled: false                     # D√©sactiv√© pour latence

      step_1_6_expansion:
        enabled: true
        technique_rewrite: true
        technique_hyde: false
        technique_multi_query: true
        technique_step_back: false
        technique_simplification: false
        technique_subquery: false
        domain_specific_prompts: false

      step_1_7_embedding:
        enabled: true
        dense_embedding: true
        sparse_embedding: false
        late_interaction: false

      step_1_8_validation:
        enabled: true
        completeness_check: true
        ambiguity_detection: false
        semantic_coherence: false
        variant_filtering: true

      step_1_9_feedback:
        enabled: false

      step_1_10_packaging:
        enabled: true
        caching: true
        metrics_tracking: true
        export_prometheus: false

  # ---------------------------------------------------------------------------
  # PRESET : balanced (Recommand√©)
  # ---------------------------------------------------------------------------
  # Configuration √©quilibr√©e qualit√©/latence/effort.
  # Gains : +40-50% qualit√©, +80ms latence
  # Effort : 2-3 semaines impl√©mentation
  # Use case : Recherche entreprise, Intranet, E-commerce
  # ---------------------------------------------------------------------------
  balanced:
    description: "Configuration √©quilibr√©e - Recommand√© pour production"
    latency_target_ms: 130
    quality_gain_estimate: "+40-50%"

    enabled_steps:
      step_1_1_query_understanding:
        enabled: true
        type_classification: true
        intent_detection: true
        complexity_scoring: true

      step_1_2_query_preprocessing:
        enabled: true
        spell_correction: true
        grammar_normalization: true
        synonym_expansion: true            # ‚úÖ Activ√©
        acronym_expansion: true            # ‚úÖ Activ√©

      step_1_3_ner:
        enabled: true                      # ‚úÖ Activ√© (spaCy)
        entity_extraction: true
        entity_boosting: true
        entity_linking: false

      step_1_4_decomposition:
        enabled: true                      # ‚úÖ Activ√© (LLM)

      step_1_5_metadata:
        enabled: true                      # ‚úÖ Activ√©
        temporal_filters: true
        geographic_filters: true
        domain_filters: true
        format_filters: false

      step_1_6_expansion:
        enabled: true
        technique_rewrite: true
        technique_hyde: true               # ‚úÖ Activ√©
        technique_multi_query: true
        technique_step_back: true          # ‚úÖ Activ√©
        technique_simplification: false
        technique_subquery: false
        domain_specific_prompts: true      # ‚úÖ Activ√©

      step_1_7_embedding:
        enabled: true
        dense_embedding: true
        sparse_embedding: true             # ‚úÖ Activ√© (SPLADE)
        late_interaction: false

      step_1_8_validation:
        enabled: true
        completeness_check: true
        ambiguity_detection: true
        semantic_coherence: true           # ‚úÖ Activ√©
        variant_filtering: true

      step_1_9_feedback:
        enabled: false                     # ‚ùå Trop lent pour balanced

      step_1_10_packaging:
        enabled: true
        caching: true
        metrics_tracking: true
        export_prometheus: true            # ‚úÖ Activ√©

  # ---------------------------------------------------------------------------
  # PRESET : maximal (SOTA)
  # ---------------------------------------------------------------------------
  # Configuration maximale pour qualit√© optimale.
  # Gains : +55-65% qualit√©, +180ms latence
  # Effort : 2-3 mois impl√©mentation
  # Use case : Recherche acad√©mique, Legal, Medical, Qualit√© primordiale
  # ---------------------------------------------------------------------------
  maximal:
    description: "Configuration maximale - SOTA"
    latency_target_ms: 230
    quality_gain_estimate: "+55-65%"

    enabled_steps:
      step_1_1_query_understanding:
        enabled: true
        type_classification: true          # ML ou LLM
        intent_detection: true
        complexity_scoring: true

      step_1_2_query_preprocessing:
        enabled: true
        spell_correction: true
        grammar_normalization: true
        synonym_expansion: true
        acronym_expansion: true

      step_1_3_ner:
        enabled: true
        entity_extraction: true            # Transformers (CamemBERT)
        entity_boosting: true
        entity_linking: true               # ‚úÖ Activ√© (Wikidata)

      step_1_4_decomposition:
        enabled: true                      # LLM

      step_1_5_metadata:
        enabled: true
        temporal_filters: true
        geographic_filters: true
        domain_filters: true
        format_filters: true               # ‚úÖ Activ√©

      step_1_6_expansion:
        enabled: true
        technique_rewrite: true
        technique_hyde: true
        technique_multi_query: true
        technique_step_back: true
        technique_simplification: true     # ‚úÖ Activ√©
        technique_subquery: true           # ‚úÖ Activ√©
        domain_specific_prompts: true

      step_1_7_embedding:
        enabled: true
        dense_embedding: true
        sparse_embedding: true             # SPLADE
        late_interaction: true             # ‚úÖ Activ√© (ColBERT)

      step_1_8_validation:
        enabled: true
        completeness_check: true
        ambiguity_detection: true
        semantic_coherence: true           # LLM-based
        variant_filtering: true

      step_1_9_feedback:
        enabled: true                      # ‚úÖ Activ√© (RaFe)

      step_1_10_packaging:
        enabled: true
        caching: true
        metrics_tracking: true
        export_prometheus: true

  # ---------------------------------------------------------------------------
  # PRESET : legacy_v1 (Backward Compatible)
  # ---------------------------------------------------------------------------
  # Configuration identique √† la v1 pour compatibilit√©.
  # Gains : Baseline (0%)
  # Use case : Migration progressive, A/B testing
  # ---------------------------------------------------------------------------
  legacy_v1:
    description: "Configuration v1 - Backward compatible"
    latency_target_ms: 50
    quality_gain_estimate: "Baseline (0%)"

    enabled_steps:
      step_1_1_query_understanding:
        enabled: false                     # ‚ùå N'existe pas en v1

      step_1_2_query_preprocessing:
        enabled: false                     # ‚ùå N'existe pas en v1

      step_1_3_ner:
        enabled: false                     # ‚ùå N'existe pas en v1

      step_1_4_decomposition:
        enabled: false                     # ‚ùå N'existe pas en v1

      step_1_5_metadata:
        enabled: false                     # ‚ùå N'existe pas en v1

      step_1_6_expansion:
        enabled: true                      # ‚úÖ Existe en v1
        technique_rewrite: true
        technique_hyde: true
        technique_multi_query: true
        technique_step_back: true
        technique_simplification: false
        technique_subquery: false
        domain_specific_prompts: false

      step_1_7_embedding:
        enabled: true
        dense_embedding: true              # ‚úÖ BGE-M3 (comme v1)
        sparse_embedding: false
        late_interaction: false

      step_1_8_validation:
        enabled: false                     # ‚ùå N'existe pas en v1

      step_1_9_feedback:
        enabled: false                     # ‚ùå N'existe pas en v1

      step_1_10_packaging:
        enabled: true
        caching: true                      # ‚úÖ Existe en v1
        metrics_tracking: false
        export_prometheus: false

# =============================================================================
# üìä MATRICE DE D√âPENDANCES
# =============================================================================
# Certaines √©tapes d√©pendent d'autres. Cette section documente les d√©pendances.
# Le syst√®me validera automatiquement la configuration au d√©marrage.
# =============================================================================

dependencies:
  # Si vous activez une √©tape avec d√©pendances, les d√©pendances doivent √™tre activ√©es aussi

  step_1_4_decomposition:
    requires:
      - step_1_1_query_understanding.complexity_scoring  # Besoin du score de complexit√©
    optional:
      - step_1_1_query_understanding.type_classification # Am√©liore la d√©composition

  step_1_6_expansion:
    requires:
      - step_1_7_embedding.dense_embedding               # Besoin embedding pour expansion
    optional:
      - step_1_1_query_understanding.type_classification # Pour adaptive expansion
      - step_1_1_query_understanding.complexity_scoring  # Pour nombre variantes adaptatif
      - step_1_5_metadata.domain_filters                 # Pour prompts domaine-specific

  step_1_8_validation:
    requires:
      - step_1_6_expansion                               # Valide les variantes g√©n√©r√©es
      - step_1_7_embedding.dense_embedding               # Pour semantic_coherence

  step_1_9_feedback:
    requires:
      - step_1_6_expansion                               # Raffine l'expansion
      - step_1_7_embedding.dense_embedding               # Pour re-embedding
    warning: "Ajoute +100ms latence - n√©cessite r√©sultats Phase 02"

  step_1_7_embedding.sparse_embedding:
    requires:
      - "Index hybride en Phase 02"                      # SPLADE n√©cessite index sparse
    warning: "N√©cessite pyserini ou √©quivalent"

  step_1_7_embedding.late_interaction:
    requires:
      - "Index ColBERT en Phase 02"                      # ColBERT n√©cessite index d√©di√©
    warning: "N√©cessite ragatouille ou colbert-ai"

# =============================================================================
# üîç VALIDATION DE CONFIGURATION
# =============================================================================
# Validation automatique au d√©marrage pour d√©tecter configurations invalides.
# =============================================================================

validation:
  enabled: true                                          # Valider config au d√©marrage

  # Comportement si d√©pendances manquantes
  # Options : "error" (bloquer), "warn" (avertir), "auto_fix" (corriger auto)
  on_missing_dependency: "warn"

  # Comportement si configuration incoh√©rente
  on_invalid_config: "error"

  # Checks √† effectuer
  checks:
    - "check_dependencies"                               # V√©rifier d√©pendances
    - "check_model_availability"                         # V√©rifier mod√®les t√©l√©charg√©s
    - "check_dictionary_paths"                           # V√©rifier dictionnaires pr√©sents
    - "check_llm_provider"                               # V√©rifier LLM accessible
    - "check_latency_budget"                             # V√©rifier budget latence r√©aliste

# =============================================================================
# üêõ MODE DEBUG
# =============================================================================
# Logging d√©taill√© de chaque sous-√©tape pour debugging.
# =============================================================================

debug:
  enabled: false                                         # D√©sactiver en production

  # Niveau de logging
  # Options : "DEBUG", "INFO", "WARNING", "ERROR"
  log_level: "DEBUG"

  # Logger chaque sous-√©tape individuellement
  log_substeps: true

  # Inclure donn√©es interm√©diaires dans les logs
  include_intermediate_data: true

  # Dur√©e max acceptable par sous-√©tape (alertes si d√©pass√©)
  latency_alerts:
    step_1_1: 15                                         # ms
    step_1_2: 25
    step_1_3: 20
    step_1_4: 30
    step_1_5: 15
    step_1_6: 100
    step_1_7: 50
    step_1_8: 15
    step_1_9: 150
    step_1_10: 10

# =============================================================================
# üíæ CONFIGURATION D√âTAILL√âE DES SOUS-√âTAPES
# =============================================================================
# Configuration fine de chaque sous-√©tape (identique √† 01_embedding_v2.yaml)
# Ces param√®tres sont utilis√©s si l'√©tape est activ√©e via master config
# =============================================================================

# [1.1] Query Understanding & Classification
query_understanding:
  # Note : enabled est contr√¥l√© par step_01_config.step_1_1_query_understanding.enabled

  type_classification:
    classifier: "heuristic"                              # "heuristic", "llm"
    heuristic:
      rules:
        factual:
          patterns: ["^(qui|quoi|quel|quelle|quand|o√π|combien|how many|what|when|where)"]
          keywords: ["d√©finition", "c'est quoi", "definition", "what is"]
        analytical:
          patterns: ["^(pourquoi|comment|why|how|explain)"]
          keywords: ["analyse", "explain", "reasoning", "cause"]
        conversational:
          patterns: ["^(peux-tu|pourrais-tu|can you|could you)"]
          keywords: ["aide-moi", "help me", "je veux", "I want"]
        navigational:
          keywords: ["document", "page", "fichier", "file"]
        comparative:
          keywords: ["diff√©rence", "comparaison", "vs", "versus", "difference", "compare"]

  intent_detection:
    method: "keyword"
    intents: ["search", "compare", "explain", "list", "navigate", "summarize", "analyze"]
    keyword_mapping:
      search: ["cherche", "trouve", "recherche", "find", "search"]
      compare: ["diff√©rence", "comparaison", "vs", "compare"]
      explain: ["explique", "pourquoi", "comment", "explain", "why", "how"]
      list: ["liste", "√©num√®re", "quels sont", "list", "what are"]

  complexity_scoring:
    factors:
      length: {weight: 0.2, thresholds: {simple: 10, medium: 25, complex: 25}}
      num_clauses: {weight: 0.3, detect_connectors: ["et", "ou", "mais", "and", "or", "but"]}
      num_entities: {weight: 0.2}
      specialized_vocab: {weight: 0.2}
      ambiguity: {weight: 0.1}
    thresholds:
      simple: 0.3
      medium: 0.6
      complex: 1.0

# [1.2] Query Preprocessing
query_preprocessing:
  spell_correction:
    corrector: "symspell"
    symspell:
      dictionary_path: "dictionaries/frequency_dictionary_fr.txt"
      max_edit_distance: 2
      prefix_length: 7
    confidence_threshold: 0.7
    preserve_named_entities: true

  grammar_normalization:
    operations:
      normalize_case: true
      remove_accents: false
      normalize_whitespace: true
      clean_punctuation: true
      lemmatize:
        enabled: true
        library: "spacy"
        model: "fr_core_news_sm"

  synonym_expansion:
    source: "wordnet"
    wordnet:
      language: "fra"
      pos_tags: ["NOUN", "VERB", "ADJ"]
    max_synonyms_per_word: 2

  acronym_expansion:
    dictionary_path: "dictionaries/acronyms.json"
    context_aware: true
    bidirectional: true

# [1.3] Named Entity Recognition
named_entity_recognition:
  extractor:
    method: "spacy"                                      # "spacy", "transformers", "llm"
    spacy:
      model: "fr_core_news_md"

  post_processing:
    normalize_entities: true
    coreference_resolution:
      enabled: false
    entity_linking:
      enabled: false

  boosting:
    weights:
      PERSON: 1.5
      ORG: 1.3
      LOC: 1.2
      DATE: 1.1
      PRODUCT: 1.4
      EVENT: 1.2
      MISC: 1.0

# [1.4] Query Decomposition
query_decomposition:
  trigger:
    min_complexity_score: 0.6
    detect_connectors: ["et", "ou", "puis", "ensuite", "and", "or", "then"]
    min_clauses: 2

  method:
    type: "llm"                                          # "rule_based", "llm"
    llm:
      provider: "ollama"
      model: "llama3"
      temperature: 0.0
      prompt_template: |
        D√©compose la question complexe suivante en sous-questions simples et atomiques.
        Chaque sous-question doit √™tre autonome. Liste chaque sous-question sur une nouvelle ligne.

        Question complexe : {query}
        Sous-questions :

  execution_strategy:
    mode: "parallel"
    merge_results: true
    merge_method: "union"

# [1.5] Metadata Extraction
metadata_extraction:
  temporal_filters:
    extractor: "dateparser"
    dateparser:
      languages: ["fr", "en"]
    patterns: ["date_point", "date_range", "relative_date", "period"]
    normalize_to_iso: true

  geographic_filters:
    extractor: "ner"
    gazetteer_path: "dictionaries/geographic_gazetteer.json"
    geo_resolution:
      enabled: true
    expand_hierarchy: true

  domain_filters:
    classifier:
      method: "keyword"
      domains: ["finance", "technology", "healthcare", "legal", "science", "education", "business", "general"]
      keyword_mapping:
        finance: ["banque", "bourse", "investissement", "finance"]
        technology: ["tech", "logiciel", "AI", "software"]
        healthcare: ["sant√©", "m√©dical", "health", "medical"]

  format_filters:
    document_types: ["pdf", "word", "excel", "powerpoint", "image"]
    patterns:
      pdf: ["pdf", "document pdf"]
      word: ["doc", "docx", "document word"]

# [1.6] Adaptive Query Expansion
adaptive_query_expansion:
  strategy_selection:
    auto_select: true
    strategies:
      factual:
        techniques: ["rewrite", "multi_query"]
        num_variants: 3
      analytical:
        techniques: ["step_back", "decomposition", "hyde"]
        num_variants: 5
      conversational:
        techniques: ["rewrite"]
        num_variants: 2
      navigational:
        techniques: []
        num_variants: 1
      comparative:
        techniques: ["decomposition", "multi_query"]
        num_variants: 4
    complexity_mapping:
      simple: 2
      medium: 4
      complex: 7

  llm:
    provider: "ollama"
    model: "llama3"
    temperature: 0.0
    max_tokens: 200

  cache:
    enabled: true
    ttl_seconds: 3600
    max_size: 10000

  techniques:
    rewrite:
      weight: 1.0
    hyde:
      weight: 1.2
    multi_query:
      num_variants: 4
      weight: 1.0
    step_back:
      weight: 1.1
    simplification:
      trigger_complexity: 0.8
    subquery_extraction:
      max_subqueries: 3

  domain_specific_prompts:
    prompts:
      general:
        hyde: |
          Vous √™tes un expert du domaine. R√©digez un document concis qui r√©pond √† la question suivante.
          Question : {query}

# [1.7] Multi-Representation Embedding
multi_representation_embedding:
  dense:
    provider: "sentence_transformers"
    model: "BAAI/bge-m3"
    embedding_dim: 1024
    quantization: "binary"
    normalize: true

  sparse:
    model: "splade"
    splade:
      model_name: "naver/splade-cocondenser-ensembledistil"
      max_nonzero_tokens: 256
      activation_threshold: 0.01

  late_interaction:
    model: "colbert-ir/colbertv2.0"
    token_embedding_dim: 128
    max_query_tokens: 32
    padding: "max_length"
    compression:
      enabled: true
      method: "quantization"

  fusion_strategy:
    strategy: "separate"
    weights:
      dense: 0.5
      sparse: 0.3
      late: 0.2

# [1.8] Query Quality Validation
query_quality_validation:
  completeness_check:
    criteria:
      min_tokens: 3
      requires_verb: true
      min_chars: 10
    min_score: 0.6

  ambiguity_detection:
    ambiguous_terms:
      high_ambiguity: ["√ßa", "truc", "chose", "it", "thing"]
      medium_ambiguity: ["l√†", "ici", "cela", "there", "here"]
    max_score: 0.5
    action: "warn"

  semantic_coherence:
    method: "embedding_similarity"
    embedding_similarity:
      model: "BAAI/bge-m3"
      min_similarity: 0.3
      max_similarity: 0.95

  variant_filtering:
    filters:
      min_quality_score: 0.5
      remove_duplicates: true
      remove_near_duplicates:
        enabled: true
        threshold: 0.95
    min_variants_to_keep: 2

# [1.9] Ranking Feedback Integration (RaFe)
ranking_feedback:
  trigger:
    conditions:
      min_initial_quality_score: 0.7
      min_query_complexity: 0.5
    mode: "conditional"

  result_analysis:
    top_k: 10
    term_extraction:
      method: "tfidf"
      num_terms: 10
      filter_stopwords: true

  reformulation:
    strategy: "term_injection"
    llm:
      provider: "ollama"
      model: "llama3"
      temperature: 0.1

  iterations:
    max_iterations: 2
    min_improvement_threshold: 0.05

# [1.10] Query Packaging & Caching
query_packaging:
  package_structure:
    include:
      - "original_query"
      - "preprocessed_query"
      - "query_type"
      - "query_intent"
      - "query_language"
      - "complexity_score"
      - "expanded_queries"
      - "dense_embeddings"
      - "sparse_embeddings"
      - "colbert_embeddings"
      - "named_entities"
      - "temporal_filters"
      - "geographic_filters"
      - "domain_filters"
      - "quality_scores"
    format: "dict"

  caching:
    backend: "memory"
    memory:
      max_size: 10000
      ttl_seconds: 3600
      eviction_policy: "lru"
    cache_key_components:
      - "query_text"
      - "language"
      - "enabled_techniques"

  metrics:
    track:
      - "total_latency_ms"
      - "preprocessing_latency_ms"
      - "expansion_latency_ms"
      - "embedding_latency_ms"
      - "num_variants_generated"
      - "num_variants_filtered"
      - "cache_hit"
      - "complexity_score"
      - "quality_score"
    export_to:
      - "prometheus"
      - "log"

# =============================================================================
# ‚ö° OPTIMISATION PERFORMANCE
# =============================================================================

performance:
  parallelization:
    enabled: true
    parallel_steps: ["ner", "spell_correction", "metadata_extraction"]
    num_workers: 4

  early_stopping:
    enabled: true
    criteria:
      min_quality_variants: 3
      min_quality_score: 0.8

  latency_budget:
    total_budget_ms: 200
    allocation:
      understanding: 10
      preprocessing: 20
      ner: 15
      decomposition: 25
      metadata: 10
      expansion: 80
      embedding: 30
      validation: 10
    on_exceed: "degrade"

# =============================================================================
# üìù NOTES D'UTILISATION
# =============================================================================
#
# D√âMARRAGE RAPIDE :
#
# 1. Mode Preset (Recommand√©) :
#    - Changez : step_01_config.mode = "preset"
#    - S√©lectionnez : step_01_config.preset = "minimal" | "balanced" | "maximal"
#    - C'est tout ! Le preset active automatiquement les bonnes √©tapes
#
# 2. Mode Custom (Contr√¥le total) :
#    - Changez : step_01_config.mode = "custom"
#    - Activez/d√©sactivez : step_01_config.step_1_X.enabled = true/false
#    - Configurez finement chaque sous-√©tape
#
# EXEMPLES :
#
# # Exemple 1 : Quick Start (minimal)
# step_01_config:
#   mode: "preset"
#   preset: "minimal"
#
# # Exemple 2 : Production (balanced)
# step_01_config:
#   mode: "preset"
#   preset: "balanced"
#
# # Exemple 3 : Custom (activer seulement NER + Expansion)
# step_01_config:
#   mode: "custom"
#   step_1_1_query_understanding: {enabled: false}
#   step_1_2_query_preprocessing: {enabled: false}
#   step_1_3_ner: {enabled: true}
#   step_1_4_decomposition: {enabled: false}
#   step_1_5_metadata: {enabled: false}
#   step_1_6_expansion: {enabled: true, technique_hyde: true}
#   step_1_7_embedding: {enabled: true, dense_embedding: true}
#   step_1_8_validation: {enabled: true}
#   step_1_9_feedback: {enabled: false}
#   step_1_10_packaging: {enabled: true}
#
# VALIDATION :
# Le syst√®me valide automatiquement les d√©pendances au d√©marrage.
# Si une √©tape n√©cessite une d√©pendance d√©sactiv√©e, vous recevrez un warning.
#
# =============================================================================
