# =============================================================================
# √âTAPE 05 v2 : G√âN√âRATION & PROMPT ENGINEERING - CONFIGURATION MODULAIRE
# =============================================================================
# Configuration avec activation/d√©sactivation GRANULAIRE de chaque sous-√©tape.
#
# NOUVEAUT√â v2.1 :
# - Section MASTER CONFIG : activer/d√©sactiver chaque √©tape facilement
# - FLAGS GRANULAIRES : contr√¥le fin de chaque feature
# - PRESETS : configurations pr√©d√©finies (minimal, balanced, maximal, cost_optimized, high_assurance)
# - Matrice de d√©pendances : validation automatique
# =============================================================================

# =============================================================================
# ‚öôÔ∏è MASTER CONFIGURATION - ACTIVATION/D√âSACTIVATION GRANULAIRE
# =============================================================================

step_05_config:
  mode: "preset"  # "preset" ou "custom"
  preset: "balanced"  # "minimal", "balanced", "maximal", "cost_optimized", "high_assurance"

  # ---------------------------------------------------------------------------
  # FLAGS D'ACTIVATION GRANULAIRE (si mode="custom")
  # ---------------------------------------------------------------------------

  # [5.1] Pre-Generation Analysis
  step_5_1_analysis:
    enabled: true                        # ‚≠ê‚≠ê‚≠ê OBLIGATOIRE
    query_complexity: true               # Classification complexity
    crag_evaluator: true                 # √âvaluation qualit√© contexte
    strategy_selection: true             # Adaptive RAG routing

  # [5.2] Prompt Construction Adaptive
  step_5_2_prompt:
    enabled: true                        # ‚≠ê‚≠ê‚≠ê OBLIGATOIRE
    adaptive_system_prompt: true         # Prompt selon query type
    context_formatting: true             # Formatage docs
    user_prompt_template: true           # Template standard

  # [5.3] Advanced Prompting Techniques
  step_5_3_advanced:
    enabled: true                        # ‚≠ê‚≠ê HIGH IMPACT
    chain_of_thought: true               # CoT si complex
    few_shot: false                      # Exemples (co√ªteux)
    self_consistency: false              # Multiple sampling (lent)
    extractive: false                    # Extraction exacte
    contrastive: false                   # Multi-perspectives

  # [5.4] Initial Generation
  step_5_4_generation:
    enabled: true                        # ‚≠ê‚≠ê‚≠ê OBLIGATOIRE
    structured_output: false             # JSON Schema
    streaming: false                     # Affichage progressif

  # [5.5] Self-RAG (Adaptive Retrieval & Reflection)
  step_5_5_self_rag:
    enabled: true                        # ‚≠ê‚≠ê HIGH IMPACT
    conditional: true                    # Si query ambig√ºe uniquement
    retrieve_on_demand: true             # Re-retrieval si n√©cessaire
    reflection_tokens: true              # IsRelevant, IsSupported, IsUseful
    regenerate_on_failure: true          # Retry si √©chec

  # [5.6] Grounded Generation (GINGER)
  step_5_6_ginger:
    enabled: false                       # ‚ö†Ô∏è Exp√©rimental (lent)
    nugget_extraction: false             # Information nuggets
    nugget_ranking: false
    claim_attribution: false             # Attribution claim-level

  # [5.7] Hallucination Detection
  step_5_7_hallucination:
    enabled: true                        # ‚≠ê‚≠ê‚≠ê CRITICAL
    lettucedetect: true                  # Lightweight (20ms)
    tlm: true                            # Deep check (50ms)
    llm_judge: false                     # Fallback (500ms)
    self_evaluation: true                # Inline (0ms)
    ragas_faithfulness: true             # Score fid√©lit√©

  # [5.8] Multi-Stage Validation
  step_5_8_validation:
    enabled: true                        # ‚≠ê‚≠ê‚≠ê CRITICAL
    faithfulness: true                   # Fid√©lit√© contexte
    attribution: true                    # Citations valides
    consistency: false                   # Coh√©rence (lent)
    completeness: true                   # Couverture question
    relevance: false                     # Pertinence

  # [5.9] Response Refinement (Iterative)
  step_5_9_refinement:
    enabled: false                       # ‚ö†Ô∏è Tr√®s lent (+2s)
    self_critique: false
    regenerate: false
    validate_improvement: false

  # [5.10] Post-Processing & Formatting
  step_5_10_post:
    enabled: true                        # ‚≠ê‚≠ê‚≠ê OBLIGATOIRE
    output_formatting: true              # Markdown/JSON/HTML
    sources_list: true                   # Liste sources
    metadata: true                       # M√©tadonn√©es
    cleanup: true                        # Nettoyage
    audit_trail: false                   # Audit (high-stakes)

# =============================================================================
# üì¶ PRESETS DE CONFIGURATION
# =============================================================================

presets:
  # ---------------------------------------------------------------------------
  # PRESET : minimal (Latence prioritaire)
  # ---------------------------------------------------------------------------
  minimal:
    description: "G√©n√©ration rapide - Latence prioritaire"
    latency_target_ms: 2500
    quality_gain: "+5%"
    cost_multiplier: 1.0

    enabled_steps:
      step_5_1_analysis:
        enabled: true
        query_complexity: true           # Heuristic uniquement
        crag_evaluator: false            # D√©sactiv√© (latence)
        strategy_selection: true         # Simple routing

      step_5_2_prompt:
        enabled: true
        adaptive_system_prompt: false    # Template fixe
        context_formatting: true
        user_prompt_template: true

      step_5_3_advanced:
        enabled: false                   # Tous d√©sactiv√©s
        chain_of_thought: false
        few_shot: false
        self_consistency: false

      step_5_4_generation:
        enabled: true
        structured_output: false
        streaming: false

      step_5_5_self_rag:
        enabled: false                   # D√©sactiv√© (latence)

      step_5_6_ginger:
        enabled: false

      step_5_7_hallucination:
        enabled: true
        lettucedetect: true              # Lightweight uniquement
        tlm: false
        llm_judge: false
        self_evaluation: false
        ragas_faithfulness: true

      step_5_8_validation:
        enabled: true
        faithfulness: true
        attribution: true                # Citations minimales
        consistency: false
        completeness: false
        relevance: false

      step_5_9_refinement:
        enabled: false

      step_5_10_post:
        enabled: true
        output_formatting: true
        sources_list: true
        metadata: false
        cleanup: true
        audit_trail: false

  # ---------------------------------------------------------------------------
  # PRESET : balanced ‚≠ê (Recommand√©)
  # ---------------------------------------------------------------------------
  balanced:
    description: "√âquilibre qualit√©/co√ªt/latence"
    latency_target_ms: 3800
    quality_gain: "+15%"
    faithfulness_gain: "+10%"
    hallucination_reduction: "-40%"
    cost_multiplier: 1.25

    enabled_steps:
      step_5_1_analysis:
        enabled: true                    # ‚úÖ Analyse compl√®te
        query_complexity: true           # Heuristic + LLM
        crag_evaluator: true             # ‚úÖ CRAG evaluator
        strategy_selection: true         # ‚úÖ Adaptive routing

      step_5_2_prompt:
        enabled: true
        adaptive_system_prompt: true     # ‚úÖ Prompt adaptatif
        context_formatting: true
        user_prompt_template: true

      step_5_3_advanced:
        enabled: true
        chain_of_thought: true           # ‚úÖ CoT si complex
        few_shot: false                  # D√©sactiv√© (co√ªt)
        self_consistency: false          # D√©sactiv√© (lent)
        extractive: false
        contrastive: false

      step_5_4_generation:
        enabled: true
        structured_output: false         # Markdown text
        streaming: false

      step_5_5_self_rag:
        enabled: true                    # ‚úÖ Self-RAG conditionnel
        conditional: true                # Si query ambig√ºe
        retrieve_on_demand: true
        reflection_tokens: true
        regenerate_on_failure: true

      step_5_6_ginger:
        enabled: false                   # D√©sactiv√© (lent)

      step_5_7_hallucination:
        enabled: true                    # ‚úÖ Detection 2 niveaux
        lettucedetect: true              # ‚úÖ Lightweight
        tlm: true                        # ‚úÖ Deep check
        llm_judge: false                 # D√©sactiv√© (co√ªt)
        self_evaluation: true            # ‚úÖ Inline
        ragas_faithfulness: true         # ‚úÖ RAGAS

      step_5_8_validation:
        enabled: true                    # ‚úÖ Validation 3 stages
        faithfulness: true               # ‚úÖ
        attribution: true                # ‚úÖ
        consistency: false
        completeness: true               # ‚úÖ
        relevance: false

      step_5_9_refinement:
        enabled: false                   # D√©sactiv√© (trop lent)

      step_5_10_post:
        enabled: true
        output_formatting: true          # Markdown
        sources_list: true
        metadata: true                   # ‚úÖ M√©tadonn√©es compl√®tes
        cleanup: true
        audit_trail: false

  # ---------------------------------------------------------------------------
  # PRESET : maximal (Qualit√© maximale)
  # ---------------------------------------------------------------------------
  maximal:
    description: "Qualit√© et fiabilit√© maximales"
    latency_target_ms: 6500
    quality_gain: "+30%"
    faithfulness_gain: "+18%"
    hallucination_reduction: "-61%"
    attribution_gain: "+45%"
    cost_multiplier: 1.80

    enabled_steps:
      step_5_1_analysis:
        enabled: true
        query_complexity: true           # LLM-based
        crag_evaluator: true             # ‚úÖ CRAG strict
        strategy_selection: true         # ‚úÖ Full adaptive

      step_5_2_prompt:
        enabled: true
        adaptive_system_prompt: true     # ‚úÖ Full adaptive
        context_formatting: true
        user_prompt_template: true

      step_5_3_advanced:
        enabled: true                    # ‚úÖ Toutes techniques
        chain_of_thought: true           # ‚úÖ CoT toujours
        few_shot: true                   # ‚úÖ Few-shot
        self_consistency: true           # ‚úÖ Multiple sampling
        extractive: false
        contrastive: true                # ‚úÖ Si analytical

      step_5_4_generation:
        enabled: true
        structured_output: true          # ‚úÖ JSON Schema
        streaming: false

      step_5_5_self_rag:
        enabled: true                    # ‚úÖ Self-RAG full
        conditional: false               # Toujours activ√©
        retrieve_on_demand: true
        reflection_tokens: true
        regenerate_on_failure: true

      step_5_6_ginger:
        enabled: true                    # ‚úÖ GINGER activ√©
        nugget_extraction: true          # ‚úÖ Information nuggets
        nugget_ranking: true
        claim_attribution: true          # ‚úÖ Claim-level citations

      step_5_7_hallucination:
        enabled: true                    # ‚úÖ Detection 4 niveaux
        lettucedetect: true
        tlm: true
        llm_judge: true                  # ‚úÖ LLM-as-Judge
        self_evaluation: true
        ragas_faithfulness: true

      step_5_8_validation:
        enabled: true                    # ‚úÖ Validation 5 stages
        faithfulness: true
        attribution: true
        consistency: true                # ‚úÖ Self-consistency
        completeness: true
        relevance: true                  # ‚úÖ Relevance check

      step_5_9_refinement:
        enabled: true                    # ‚úÖ Refinement 1-2 iterations
        self_critique: true
        regenerate: true
        validate_improvement: true

      step_5_10_post:
        enabled: true
        output_formatting: true          # Rich formatting
        sources_list: true
        metadata: true
        cleanup: true
        audit_trail: false

  # ---------------------------------------------------------------------------
  # PRESET : cost_optimized (Co√ªts minimaux)
  # ---------------------------------------------------------------------------
  cost_optimized:
    description: "Minimiser co√ªts API"
    latency_target_ms: 2800
    quality_gain: "+8%"
    cost_multiplier: 0.60

    enabled_steps:
      step_5_1_analysis:
        enabled: true
        query_complexity: true           # Heuristic uniquement (pas LLM)
        crag_evaluator: false            # D√©sactiv√© (co√ªt)
        strategy_selection: true         # Simple routing

      step_5_2_prompt:
        enabled: true
        adaptive_system_prompt: false    # Templates statiques
        context_formatting: true
        user_prompt_template: true

      step_5_3_advanced:
        enabled: false                   # Tous d√©sactiv√©s (co√ªt)

      step_5_4_generation:
        enabled: true
        structured_output: true          # ‚úÖ Structured (pas de retry)
        streaming: false

      step_5_5_self_rag:
        enabled: false                   # D√©sactiv√© (re-retrieval co√ªteux)

      step_5_6_ginger:
        enabled: false

      step_5_7_hallucination:
        enabled: true
        lettucedetect: true              # ‚úÖ Local model uniquement
        tlm: false                       # D√©sactiv√© (API payante)
        llm_judge: false                 # D√©sactiv√© (tr√®s co√ªteux)
        self_evaluation: false
        ragas_faithfulness: true         # ‚úÖ RAGAS uniquement

      step_5_8_validation:
        enabled: true
        faithfulness: true               # ‚úÖ Faithfulness uniquement
        attribution: true                # ‚úÖ Citations basiques
        consistency: false
        completeness: false
        relevance: false

      step_5_9_refinement:
        enabled: false

      step_5_10_post:
        enabled: true
        output_formatting: true
        sources_list: true
        metadata: false                  # M√©tadonn√©es minimales
        cleanup: true
        audit_trail: false

    # Configuration caching agressif
    caching:
      enabled: true
      ttl: 86400  # 24h
      query_similarity_threshold: 0.95

  # ---------------------------------------------------------------------------
  # PRESET : high_assurance (M√©dical, L√©gal, Critique)
  # ---------------------------------------------------------------------------
  high_assurance:
    description: "Fiabilit√© maximale - Zero tolerance hallucinations"
    latency_target_ms: 5500
    quality_gain: "+25%"
    hallucination_reduction: "-72%"
    attribution_gain: "+50%"
    refusal_rate_increase: "+200%"
    cost_multiplier: 1.70

    enabled_steps:
      step_5_1_analysis:
        enabled: true
        query_complexity: true
        crag_evaluator: true             # ‚úÖ CRAG tr√®s strict
        strategy_selection: true

      step_5_2_prompt:
        enabled: true
        adaptive_system_prompt: true     # ‚úÖ Conservative prompts
        context_formatting: true
        user_prompt_template: true

      step_5_3_advanced:
        enabled: true
        chain_of_thought: true
        few_shot: false
        self_consistency: false
        extractive: true                 # ‚úÖ Pr√©f√©rer extraction
        contrastive: false

      step_5_4_generation:
        enabled: true
        structured_output: true          # ‚úÖ Structured
        streaming: false
        temperature: 0.0                 # ‚úÖ D√©terministe strict

      step_5_5_self_rag:
        enabled: true                    # ‚úÖ Self-RAG strict
        conditional: false               # Toujours activ√©
        retrieve_on_demand: true
        reflection_tokens: true
        regenerate_on_failure: true
        strict_thresholds: true          # ‚úÖ Thresholds stricts

      step_5_6_ginger:
        enabled: true                    # ‚úÖ GINGER pour tra√ßabilit√©
        nugget_extraction: true
        nugget_ranking: true
        claim_attribution: true          # ‚úÖ Claim-level attribution

      step_5_7_hallucination:
        enabled: true                    # ‚úÖ Detection maximale
        lettucedetect: true
        tlm: true
        llm_judge: true                  # ‚úÖ LLM-as-Judge
        self_evaluation: true
        ragas_faithfulness: true
        human_in_loop: true              # ‚úÖ Human validation si doute

      step_5_8_validation:
        enabled: true                    # ‚úÖ Validation stricte
        faithfulness: true
        attribution: true
        consistency: true
        completeness: true
        relevance: true
        strict_thresholds: true          # ‚úÖ Thresholds √©lev√©s

      step_5_9_refinement:
        enabled: true                    # ‚úÖ Si √©chec validation
        conditional: true                # Uniquement si n√©cessaire
        self_critique: true
        regenerate: true

      step_5_10_post:
        enabled: true
        output_formatting: true
        sources_list: true
        metadata: true
        cleanup: true
        audit_trail: true                # ‚úÖ Audit trail complet

    # Configuration refuse to answer
    refuse_to_answer:
      enabled: true
      strict_mode: true
      min_confidence: 0.9
      min_faithfulness: 0.90
      refuse_message: |
        Je n'ai pas suffisamment d'informations fiables dans le contexte fourni
        pour r√©pondre √† cette question avec le niveau de confiance requis.

# =============================================================================
# üìä MATRICE DE D√âPENDANCES
# =============================================================================

dependencies:
  step_5_1_analysis.query_complexity:
    optional:
      - "Phase 01: step_1_1_query_understanding"
    warning: "Query complexity classification sera heuristic sans Phase 01"

  step_5_1_analysis.crag_evaluator:
    requires:
      - "Phase 04: compressed context"
      - "cross-encoder model"
    warning: "CRAG n√©cessite cross-encoder (100MB)"

  step_5_3_advanced.chain_of_thought:
    requires:
      - "step_5_1_analysis.query_complexity"
    warning: "CoT plus efficace avec query complexity classification"

  step_5_5_self_rag:
    requires:
      - "Phase 02: retrieval system"
    warning: "Self-RAG n√©cessite acc√®s au retrieval pour re-retrieval"

  step_5_6_ginger:
    requires:
      - "LLM pour nugget extraction"
    warning: "GINGER ajoute +200-500ms latence"

  step_5_7_hallucination.tlm:
    requires:
      - "Cleanlab API key"
    install: "pip install cleanlab"

  step_5_7_hallucination.lettucedetect:
    requires:
      - "transformers library"
    install: "pip install transformers"

  step_5_8_validation.faithfulness:
    requires:
      - "RAGAS library"
    install: "pip install ragas"

# =============================================================================
# üîç VALIDATION DE CONFIGURATION
# =============================================================================

validation:
  enabled: true
  on_missing_dependency: "warn"
  on_invalid_config: "error"

  checks:
    - "check_dependencies"
    - "check_library_availability"  # LettuceDetect, TLM, RAGAS
    - "check_llm_provider"
    - "check_api_keys"

# =============================================================================
# üêõ MODE DEBUG
# =============================================================================

debug:
  enabled: false
  log_level: "DEBUG"
  log_substeps: true

  include_generation_stats: true

  latency_alerts:
    step_5_1: 200   # Pre-generation analysis
    step_5_2: 50    # Prompt construction
    step_5_3: 0     # Advanced prompting (inline)
    step_5_4: 2000  # Initial generation
    step_5_5: 1000  # Self-RAG
    step_5_6: 500   # GINGER
    step_5_7: 200   # Hallucination detection
    step_5_8: 250   # Validation
    step_5_9: 2000  # Refinement
    step_5_10: 100  # Post-processing

# =============================================================================
# üíæ CONFIGURATION D√âTAILL√âE DES SOUS-√âTAPES
# =============================================================================

# [5.1] Pre-Generation Analysis
pre_generation_analysis:
  query_complexity:
    heuristic_factors:
      query_length_weight: 0.2
      num_entities_weight: 0.3
      question_words_weight: 0.2
      comparison_words_weight: 0.3

  crag_evaluator:
    model: "cross-encoder/ms-marco-MiniLM-L-6-v2"
    thresholds:
      correct: 0.7
      ambiguous: 0.4

# [5.2] Prompt Construction
prompt_construction:
  system_prompts:
    factual: "concise_factual_template"
    analytical: "step_by_step_analytical_template"
    comparative: "structured_comparison_template"

  context_formatting:
    max_tokens_per_doc: 500
    separator: "\n\n---\n\n"

# [5.3] Advanced Prompting
advanced_prompting:
  chain_of_thought:
    format: "explicit"
    trigger_on_complexity: ["complex"]

  self_consistency:
    num_samples: 3
    temperature: 0.5
    aggregation: "voting"

# [5.4] Initial Generation
initial_generation:
  llm:
    provider: "ollama"
    model: "llama3"
    temperature: 0.0
    max_tokens: 1000

# [5.5] Self-RAG
self_rag:
  activation_triggers:
    query_complexity: ["complex"]
    crag_score: ["ambiguous"]

  reflection:
    is_relevant_threshold: 3
    is_supported_threshold: "Partially"
    is_useful_threshold: 3

# [5.7] Hallucination Detection
hallucination_detection:
  lettucedetect:
    model: "adaamko/lettucedetect"
    threshold: 0.5

  tlm:
    threshold: 0.7

  ragas_faithfulness:
    min_score: 0.85

# [5.8] Multi-Stage Validation
multi_stage_validation:
  faithfulness:
    method: "ragas"
    min_score: 0.85

  attribution:
    min_citations: 1
    verify_citations_accurate: true

  completeness:
    method: "llm"
    llm_model: "llama3"

# [5.9] Response Refinement
response_refinement:
  max_iterations: 2
  improvement_threshold: 0.05

# [5.10] Post-Processing
post_processing:
  formatting:
    output_format: "markdown"

  sources_list:
    append: true
    format: "compact"

# =============================================================================
# üìù NOTES D'UTILISATION
# =============================================================================
#
# D√âMARRAGE RAPIDE :
#
# 1. Mode Preset (Recommand√©) :
#    step_05_config:
#      mode: "preset"
#      preset: "balanced"  # ‚≠ê Recommand√©
#
# 2. Mode Custom (Contr√¥le granulaire) :
#    step_05_config:
#      mode: "custom"
#      step_5_7_hallucination:
#        enabled: true
#        lettucedetect: true
#        tlm: true
#
# CONTR√îLE GRANULAIRE AVANC√â :
#
# # Activer Self-RAG toujours (pas conditionnel)
# step_05_config:
#   step_5_5_self_rag:
#     enabled: true
#     conditional: false  # Toujours activ√©
#
# # Activer GINGER (claim-level citations)
# step_05_config:
#   step_5_6_ginger:
#     enabled: true
#     nugget_extraction: true
#     claim_attribution: true
#
# # Activer Response Refinement (high-stakes)
# step_05_config:
#   step_5_9_refinement:
#     enabled: true
#     max_iterations: 2
#
# OPTIMISATION PAR USE CASE :
#
# - FAQ/Support : preset="minimal" (2.5s, +5%, co√ªt baseline)
# - Entreprise : preset="balanced" (3.8s, +15%, +25% co√ªt)
# - Recherche/Analyse : preset="maximal" (6.5s, +30%, +80% co√ªt)
# - Cost-Sensitive : preset="cost_optimized" (2.8s, +8%, -40% co√ªt)
# - M√©dical/L√©gal : preset="high_assurance" (5.5s, +25%, -72% hallucinations)
#
# PRESETS COMPARAISON :
#
# | Preset | Latence | Qualit√© | Faithfulness | Hallucinations | Co√ªt |
# |--------|---------|---------|--------------|----------------|------|
# | minimal | 2.5s | +5% | baseline | baseline | 1.0x |
# | balanced ‚≠ê | 3.8s | +15% | +10% | -40% | 1.25x |
# | maximal | 6.5s | +30% | +18% | -61% | 1.80x |
# | cost_optimized | 2.8s | +8% | +5% | -20% | 0.60x |
# | high_assurance | 5.5s | +25% | +15% | -72% | 1.70x |
#
# =============================================================================
