# =============================================================================
# PRE-COMMIT HOOKS CONFIGURATION (RAG ULTIME 2025)
# =============================================================================
# Hooks Git automatiques pour maintenir la qualité du code.
#
# Installation :
#   pip install pre-commit
#   pre-commit install
#
# Utilisation :
#   pre-commit run --all-files    # Lancer manuellement sur tous les fichiers
#   git commit                    # Hooks exécutés automatiquement
#
# Conformité GEMINI :
# - ruff : remplace black (formatter) + flake8 (linter) + isort (imports)
# - mypy : vérification typage statique strict
# - Checks standards : trailing-whitespace, yaml syntax, etc.
# =============================================================================

repos:
  # ===========================================================================
  # HOOKS STANDARDS (Nettoyage & Validation)
  # ===========================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # Supprimer trailing whitespace
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]

      # Assurer newline en fin de fichier
      - id: end-of-file-fixer

      # Vérifier syntaxe YAML
      - id: check-yaml
        args: [--safe]

      # Vérifier syntaxe TOML
      - id: check-toml

      # Vérifier syntaxe JSON
      - id: check-json

      # Détecter ajout de gros fichiers (>500KB)
      - id: check-added-large-files
        args: [--maxkb=500]

      # Détecter merge conflicts non résolus
      - id: check-merge-conflict

      # Détecter clés dupliquées dans JSON/YAML
      - id: check-json
      - id: check-yaml

      # Empêcher commit direct sur branches protégées
      - id: no-commit-to-branch
        args: [--branch, main, --branch, master]

  # ===========================================================================
  # RUFF (Formatter + Linter ultra-rapide)
  # ===========================================================================
  # Remplace black + flake8 + isort en un seul outil
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.4.1
    hooks:
      # Formatter (style Black)
      - id: ruff-format
        name: "ruff format (formatter)"
        description: "Format code with ruff (Black style)"

      # Linter avec auto-fix
      - id: ruff
        name: "ruff check (linter)"
        description: "Lint code with ruff and auto-fix issues"
        args: [--fix, --exit-non-zero-on-fix]

  # ===========================================================================
  # MYPY (Vérification typage statique)
  # ===========================================================================
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.5.1
    hooks:
      - id: mypy
        name: "mypy (type checking)"
        description: "Static type checking with mypy strict mode"
        # Fichiers Python seulement
        files: ^src/.*\.py$
        # Dépendances supplémentaires pour stubs
        additional_dependencies:
          - types-pyyaml
          - types-requests
          - pydantic>=2.0
        # Options mypy (strict mode défini dans pyproject.toml)
        args: [--config-file=pyproject.toml]

  # ===========================================================================
  # PYTEST (Tests automatiques - optionnel)
  # ===========================================================================
  # Décommenter pour exécuter tests à chaque commit (peut ralentir)
  # - repo: local
  #   hooks:
  #     - id: pytest
  #       name: "pytest (run tests)"
  #       description: "Run pytest test suite"
  #       entry: pytest
  #       language: system
  #       types: [python]
  #       pass_filenames: false
  #       always_run: true
  #       args: [-v, --tb=short, -m, "not slow"]

# =============================================================================
# CONFIGURATION PRE-COMMIT
# =============================================================================
# Exécution séquentielle des hooks (un échec bloque les suivants)
fail_fast: false

# Ignorer certains fichiers globalement
exclude: |
  (?x)^(
    .*\.egg-info/.*|
    .*/__pycache__/.*|
    .*/\.venv/.*|
    .*/venv/.*|
    .*\.pyc$|
    .*\.pyo$
  )$

# =============================================================================
# NOTES
# =============================================================================
# Ordre d'exécution des hooks :
# 1. Hooks standards (nettoyage, validation syntax)
# 2. ruff-format (formatage du code)
# 3. ruff check (linting avec auto-fix)
# 4. mypy (vérification typage statique)
# 5. (optionnel) pytest (tests unitaires)
#
# Si un hook échoue :
# - Les modifications sont annulées
# - Le commit est bloqué
# - Corriger les erreurs et recommiter
#
# Bypass (déconseillé) :
#   git commit --no-verify
# =============================================================================
